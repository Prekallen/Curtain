{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block content %}
<div class="container py-5">

    <h2 class="mb-4 text-light">시공 정보</h2>
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- ConstructionForm -->
        <div class="mb-3">
            <label for="{{ form.address.id_for_label }}" class="form-label text-light">주소</label>
            {{ form.address|add_class:"form-control" }}
        </div>

        <div class="mb-5">
            <label for="{{ form.housing_type.id_for_label }}" class="form-label text-light">주거 형태</label>
            {{ form.housing_type|add_class:"form-control" }}
        </div>

        <hr class="text-light">

        <!-- ConstItemFormSet -->
        <h3 class="mb-3 text-success">시공 품목</h3>
        <div id="formset-container">
            {{ const_item_formset.management_form }}

            {% for item_form, image_formset in paired_forms %}
            <div class="card bg-dark text-light mb-4 p-3 item-form">
                <h5 class="mb-3 text-info">품목 #{{ forloop.counter }}</h5>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="{{ item_form.item_type.id_for_label }}" class="form-label">품목</label>
                        {{ item_form.item_type|add_class:"form-select" }}
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="{{ item_form.item_name.id_for_label }}" class="form-label">이름</label>
                        {{ item_form.item_name|add_class:"form-control" }}
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="{{ item_form.item_detail.id_for_label }}" class="form-label">설명</label>
                        {{ item_form.item_detail|add_class:"form-control" }}
                    </div>
                </div>

                <!-- 이미지 섹션 -->
                <div class="mt-4">
                    <h6 class="text-light">이미지 업로드</h6>

                    {% if image_formset.non_form_errors %}
                    <div class="text-danger small mb-2">
                        {{ image_formset.non_form_errors }}
                    </div>
                    {% endif %}

                    <div class="row image-container" id="image-container-{{ forloop.counter0 }}">
                        {{ image_formset.management_form }}
                        {% for image_form in image_formset %}
                        <div class="col-6 col-md-4 col-lg-3 mb-4 image-form">
                            {{ image_form.image_path|add_class:"form-control image-input" }}

                            {% if image_form.instance.image_path %}
                            <img src="{{ image_form.instance.image_path.url }}"
                                 class="img-thumbnail mt-2 w-100 image-preview"
                                 style="height: 200px; object-fit: cover;"
                                 alt="이미지 미리보기">
                            {% else %}
                            <img class="image-preview mt-2 w-100" style="display:none; height:200px; object-fit: cover;">
                            {% endif %}

                            <button type="button" class="btn btn-sm btn-outline-danger mt-2 delete-image">삭제</button>
                        </div>
                        {% endfor %}
                    </div>

                    <button type="button"
                            class="btn btn-sm btn-outline-light mt-2 add-image"
                            data-index="{{ forloop.counter0 }}">
                        + 이미지 추가
                    </button>
                </div>

                <button type="button" class="btn btn-danger mt-4 w-100 delete-item">품목 삭제</button>
            </div>
            {% endfor %}
        </div>

        <div class="mb-4">
            <button type="button" class="btn btn-outline-light" id="add-item-btn">+ 품목 추가</button>
        </div>

        <hr class="text-light">

        <!-- Submit Button -->
        <div class="text-center">
            <button type="submit" class="btn btn-success px-5">저장</button>
        </div>
    </form>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    const maxImages = 5;

    $(document).ready(function () {
        // 이미지 미리보기
        $(document).on('change', '.image-input', function () {
            const preview = $(this).siblings('.image-preview')[0];
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(this.files[0]);
            }
        });

        // 이미지 삭제
        $(document).on('click', '.delete-image', function () {
            const container = $(this).closest('.image-container');
            const imageForms = container.find('.image-form');

            if (imageForms.length > 1) {
                $(this).closest('.image-form').remove();

                // 총 개수 다시 설정
                const totalFormsInput = container.find('input[name$="-TOTAL_FORMS"]');
                const newCount = container.find('.image-form').length;
                totalFormsInput.val(newCount);
            } else {
                alert('최소 한 개의 이미지는 등록해야 합니다.');
            }
        });

        // 이미지 추가
        $(document).on('click', '.add-image', function () {
            const index = $(this).data('index');
            const container = $(`#image-container-${index}`);
            const totalFormsInput = container.find('input[name$="-TOTAL_FORMS"]');
            let formCount = parseInt(totalFormsInput.val());

            if (formCount >= maxImages) {
                alert('이미지는 품목당 최대 5개까지만 추가할 수 있습니다.');
                return;
            }

            const firstForm = container.find('.image-form:first');
            const newForm = firstForm.clone();

            newForm.find('input, select, textarea').each(function () {
                const name = $(this).attr('name');
                const id = $(this).attr('id');
                if (name && id) {
                    const newName = name.replace(/-\d+-/, `-${formCount}-`);
                    const newId = id.replace(/-\d+-/, `-${formCount}-`);
                    $(this).attr({ name: newName, id: newId }).val('');
                }
            });

            newForm.find('.image-preview').attr('src', '').hide();
            container.append(newForm);
            totalFormsInput.val(formCount + 1);
        });

        // 품목 삭제 (1개는 남겨야 함)
        $(document).on('click', '.delete-item', function () {
            if ($('.item-form').length > 1) {
                $(this).closest('.item-form').remove();

                // 품목 번호 재정렬 (선택)
                $('.item-form').each(function (i) {
                    $(this).find('h5').text(`품목 #${i + 1}`);
                });
            } else {
                alert('최소 1개의 품목은 남겨야 합니다.');
            }
        });

        // 품목 추가
        const totalItemsInput = $('#id_items-TOTAL_FORMS');
        const itemContainer = $('#formset-container');
        const itemTemplate = itemContainer.children('.item-form:first').clone();

        $('#add-item-btn').on('click', function () {
            let formIdx = parseInt(totalItemsInput.val());
            const newItem = itemTemplate.clone();

            // 필드 초기화 및 name/id 재정렬
            newItem.find('input, select, textarea').each(function () {
                const name = $(this).attr('name');
                const id = $(this).attr('id');
                if (name && id) {
                    const newName = name.replace(/-\d+-/, `-${formIdx}-`);
                    const newId = id.replace(/-\d+-/, `-${formIdx}-`);
                    $(this).attr({ name: newName, id: newId });

                    if ($(this).is(':checkbox') || $(this).is(':radio')) {
                        $(this).prop('checked', false);
                    } else {
                        $(this).val('');
                    }
                }
            });

            // 이미지 formset 초기화 (1개만)
            newItem.find('.image-form').not(':first').remove();
            newItem.find('.image-preview').hide().attr('src', '');
            newItem.find('input[name$="-TOTAL_FORMS"]').val(1);

            // 고유 인덱스 설정
            newItem.find('h5').text(`품목 #${formIdx + 1}`);
            newItem.find('.image-container')
                .attr('id', `image-container-${formIdx}`);
            newItem.find('.add-image').attr('data-index', formIdx);

            totalItemsInput.val(formIdx + 1);
            itemContainer.append(newItem);
        });
    });
</script>
{% endblock %}
